services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile.custom
      args:
        OPENCLAW_DOCKER_APT_PACKAGES: ${OPENCLAW_DOCKER_APT_PACKAGES}
    environment:
      BRAVE_API_KEY: ${BRAVE_API_KEY}
      PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH: /usr/lib/chromium/chromium
      TZ: Europe/Istanbul
    labels:
      # 1. Middleware Tanımları
      - "traefik.http.middlewares.openclaw-auth.basicauth.users=${DASHBOARD_USER}:${DASHBOARD_HASH}"
      - "traefik.http.middlewares.pi-allow.ipallowlist.sourcerange=${ALLOWED_IP}"
      
      # 2. Mevcut router'a middleware zinciri ekle (Önce IP'ye bak, değilse şifre sor)
      - "traefik.http.routers.openclaw-pi.rule=Host(`bot.myvps.tr`) && ClientIP(`${ALLOWED_IP}`)"
      - "traefik.http.routers.openclaw-pi.entrypoints=websecure"
      - "traefik.http.routers.openclaw-pi.priority=100"
      - "traefik.http.routers.openclaw-pi.service=gerekli-openclaw-bx3fba-103-websecure"
      - "traefik.http.routers.openclaw-pi.tls.certresolver=letsencrypt"

      # --- Ana router'a sadece şifreleme ekle ---
      - "traefik.http.routers.gerekli-openclaw-bx3fba-103-websecure.middlewares=openclaw-auth"
      - "traefik.http.routers.gerekli-openclaw-bx3fba-103-websecure.priority=50"


  openclaw-cli:
    build:
      context: .
      dockerfile: Dockerfile.custom
      args:
        OPENCLAW_DOCKER_APT_PACKAGES: ${OPENCLAW_DOCKER_APT_PACKAGES}
    environment:
      TZ: Europe/Istanbul
